<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<div th:replace="assets/topbar :: setContent('')"></div>
<main class="container mx-auto mt-8">
    <!-- ê¸€ ë‚´ìš© -->
    <div class="bg-white shadow-md rounded p-6">
        <p class="text-gray-500 text-l"
           th:text="${dto.boardMajor}+' ê²Œì‹œíŒ'">
        </p>
        <h2 class="text-2xl font-bold" th:text="${dto.title}"></h2>
        <p class="text-gray-500 text-sm"
           th:text="'ì‘ì„±ì: ' + ${dto.writerName} + ' | '+ ${dto.writerMajor} + ' | '+'ì‘ì„±ì¼: '+ ${#temporals.format(dto.regDate, 'yyyy.MM.dd HH:mm')} + (${dto.modDate != dto.regDate} ? ' | ìˆ˜ì •ì¼: ' + ${#temporals.format(dto.modDate, 'yyyy.MM.dd HH:mm')} : '')">
        </p>



        <p class="mt-4 text-gray-800" th:text="${dto.content}"></p>

        <!-- ì¶”ì²œ/ë¹„ì¶”ì²œ ë²„íŠ¼ -->
        <div class="flex justify-center items-center mt-6 space-x-8">
            <!-- ì¶”ì²œ ë²„íŠ¼ -->
            <button
                    class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
                    id="like"
                    th:disabled="${!loginDTO.login}" >
                <span class="text-lg">ğŸ‘</span>
                <span class="ml-2" th:text="'ì¶”ì²œ(' + ${dto.likes} + ')'"></span>
            </button>

            <!-- ë¹„ì¶”ì²œ ë²„íŠ¼ -->
            <button
                    class="flex items-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
                    id="dislike"
                    th:disabled="${!loginDTO.login}">
                <span class="text-lg">ğŸ‘</span>
                <span class="ml-2" th:text="'ë¹„ì¶”ì²œ(' + ${dto.disLikes} + ')'"></span>
            </button>
    </div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <div class="bg-white shadow-md rounded p-6 mt-6">
        <h3 class="text-xl font-bold mb-4 flex items-center">
            ëŒ“ê¸€
            <!-- ëŒ“ê¸€ ê°œìˆ˜ í‘œì‹œ -->
            <span id="replyCount" class="text-sm text-gray-600 ml-2" th:text="'('+${dto.replyCount}+'ê°œ)'"></span>
        </h3>
        <ul id="replyList">
            <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </ul>
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="pagination" class="mt-4 flex justify-center space-x-2">
            <!-- í˜ì´ì§€ ë²ˆí˜¸ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

        <!-- ëŒ“ê¸€ ì‘ì„± -->
        <form id="replyForm" class="mt-4" th:if="${loginDTO.login != null}"
              th:style="${!loginDTO.login} ? 'display: none;' : ''">
            <input id="boardId" type="hidden" th:value=" ${dto.id}">
            <input id="writerNickName" type="hidden" th:value=" ${loginDTO.nickName}">
            <textarea id="replyContent" class="w-full border rounded p-2" rows="3" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”." required></textarea>
            <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 mt-2">
                ëŒ“ê¸€ ì‘ì„±
            </button>
        </form>
    </div>

    <!-- ë’¤ë¡œê°€ê¸° ë° ìˆ˜ì • ë²„íŠ¼ -->
    <div class="text-right mt-2 flex justify-end space-x-4">
        <div class="text-right mt-4 flex justify-end space-x-4">
            <!-- ì‚­ì œí•˜ê¸° ë²„íŠ¼ -->
            <form th:action="@{/board/remove}" method="post" th:if="${loginDTO.Role} == 'ADMIN' or ${dto.writerName} == ${loginDTO.nickName}"
                  th:object="${dto}" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                <input type="hidden" name="id" th:value="${dto.id}">
                <input type="hidden" name="page" th:value="${requestDTO.page}">
                <input type="hidden" name="type" th:value="${requestDTO.type}">
                <input type="hidden" name="keyword" th:value="${requestDTO.keyword}">
                <input type="hidden" name="category" th:value="${requestDTO.category}">
                <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                    ì‚­ì œí•˜ê¸°
                </button>
            </form>
            <!-- ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ -->
            <a th:if=" ${dto.writerName} == ${loginDTO.nickName}" th:href="@{/board/modify(id=${dto.id}, page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO.category})}"
               class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                ìˆ˜ì •í•˜ê¸°
            </a>
            <!-- ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ -->
            <a th:href="@{/board/list(page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO.category})}"
               class="bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 mb-2">
                ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>

    </div>
</main>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const memberWriter = document.getElementById("writerNickName").value;
    function enableEdit(replyId, currentContent) {
        const contentDiv = document.getElementById(`content-${replyId}`);
        contentDiv.innerHTML = `
        <textarea class="w-full border rounded p-2 mb-2" id="editContent-${replyId}">${currentContent}</textarea>
        <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
            onclick="saveReply(${replyId})">ì €ì¥</button>
    `;
    }
    function deleteReply(replyId) {
        // ì‚¬ìš©ìì—ê²Œ ì‚­ì œ í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ
        const userConfirmed = confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

        if (userConfirmed) {
            // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆŒë €ì„ ë•Œë§Œ ì‚­ì œ ìš”ì²­ ìˆ˜í–‰
            fetch(`/api/user/deleteReply`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
                },
                body: JSON.stringify({ id: replyId }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                    }
                    return response.json();
                })
                .then((data) => {
                    // ì‚­ì œ í›„ ëŒ“ê¸€ ë‚´ìš© ê°±ì‹ 
                    location.reload();
                })
                .catch((error) => console.error(error.message));
        } else {
            // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ëˆŒë €ì„ ê²½ìš°
        }
    }
    document.getElementById("like").addEventListener("click", function (event) {
        if (confirm("ì´ ê²Œì‹œê¸€ì„ ì¶”ì²œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const boardId = document.getElementById("boardId").value;

            fetch("/api/board/updateLike", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
                },
                body: JSON.stringify({
                    boardId: boardId,
                    likeStatus: true
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("ì¶”ì²œ ìš”ì²­ ì‹¤íŒ¨");
                    }
                    return response.json();
                })
                .then((data) => {
                    alert(data.message); // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ alertë¡œ ì¶œë ¥
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                })
                .catch((error) => {
                    alert(error.message); // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                });
        }
    });

    // ë¹„ì¶”ì²œ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("dislike").addEventListener("click", function (event) {
        if (confirm("ì´ ê²Œì‹œê¸€ì„ ë¹„ì¶”ì²œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const boardId = document.getElementById("boardId").value;

            fetch("/api/board/updateLike", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
                },
                body: JSON.stringify({
                    boardId: boardId,
                    likeStatus: false
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("ë¹„ì¶”ì²œ ìš”ì²­ ì‹¤íŒ¨");
                    }
                    return response.json();
                })
                .then((data) => {
                    alert(data.message); // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¥¼ alertë¡œ ì¶œë ¥
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                })
                .catch((error) => {
                    alert(error.message); // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                });
        }
    });
    document.getElementById("replyForm").addEventListener("submit", function (event) {
        event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ ë°©ì‹ì„ ë°©ì§€

        // ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const content = document.getElementById("replyContent").value;
        const boardId = document.getElementById("boardId").value;
        // ì„œë²„ë¡œ ì „ì†¡
        fetch("/api/user/addReply", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken // CSRF í† í° ì¶”ê°€
            },
            body: JSON.stringify({
                memberWriter: memberWriter,
                content: content,
                boardId: boardId
            })
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
                }
                return response.json();
            })
            .then((data) => {
                location.reload();
            })
            .catch((error) => {
                alert(error.message);
            });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const boardId = document.getElementById("boardId").value;
        const replyListElement = document.getElementById("replyList");
        const paginationElement = document.getElementById("pagination");

        // ëŒ“ê¸€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function fetchReplies(page = 1) {
            fetch(`/api/user/getReplyList?boardId=${boardId}&page=${page}`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("ëŒ“ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                    return response.json();
                })
                .then((data) => {
                    renderReplies(data.dtoList);
                    renderPagination(data.pageList, data.page, data.prev, data.next);
                })
                .catch((error) => {
                    console.error(error.message);
                });
        }

        // ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
        function renderReplies(replies) {
            replyListElement.innerHTML = replies
                .map(
                    (reply) =>
            `
                    <li class="border-b py-4 flex justify-between items-center">
    <!-- ëŒ“ê¸€ ë‚´ìš© -->
                        <div id="content-${reply.id}">
                            <p class="text-gray-800">${reply.content}</p>
                            <p class="text-gray-500 text-sm">ì‘ì„±ì: ${reply.writer} | ${new Date(reply.regDate).toLocaleString()}</p>
                        </div>
                        <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
                        ${

                        reply.writer === memberWriter
                            ? `
                        <div class="flex space-x-2">
                             <button class="text-blue-600 hover:underline" onclick="enableEdit(${reply.id}, '${reply.content}')">ìˆ˜ì •</button>
                            <button class="text-red-600 hover:underline" onclick="deleteReply(${reply.id})">ì‚­ì œ</button>
                        </div>
                        `
                            : ""
                    }
                    </li>
                `
                )
                .join("");
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        function renderPagination(pageList, currentPage, hasPrev, hasNext) {
            paginationElement.innerHTML = "";

            // ì´ì „ ë²„íŠ¼
            if (hasPrev) {
                const prevButton = document.createElement("button");
                prevButton.textContent = "ì´ì „";
                prevButton.className = "px-3 py-1 bg-gray-300 rounded";
                prevButton.addEventListener("click", () => fetchReplies(currentPage - 1));
                paginationElement.appendChild(prevButton);
            }

            // í˜ì´ì§€ ë²ˆí˜¸
            pageList.forEach((page) => {
                const pageButton = document.createElement("button");
                pageButton.textContent = page;
                pageButton.className = `px-3 py-1 ${page === currentPage ? "bg-blue-600 text-white" : "bg-gray-300"} rounded`;
                pageButton.addEventListener("click", () => fetchReplies(page));
                paginationElement.appendChild(pageButton);
            });

            // ë‹¤ìŒ ë²„íŠ¼
            if (hasNext) {
                const nextButton = document.createElement("button");
                nextButton.textContent = "ë‹¤ìŒ";
                nextButton.className = "px-3 py-1 bg-gray-300 rounded";
                nextButton.addEventListener("click", () => fetchReplies(currentPage + 1));
                paginationElement.appendChild(nextButton);
            }
        }

        // ì´ˆê¸° ëŒ“ê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        fetchReplies();
    });


</script>
</html>
